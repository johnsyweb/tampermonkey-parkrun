# Pete's parkrun userscripts

## A script or scripts for messing with parkrun results pages

You'll need something like [Tampermonkey](https://www.tampermonkey.net) if
you'd like to enjoy them. Or you can use the bookmarklet versions.

## Why?

Why not?

## Bookmarklets

You can also use these scripts as bookmarklets by creating bookmarks with the following URLs:

### parkrun Wilson index display

The "Wilson index" in parkrun is the highest consecutive event number completed, starting from #1. This script calculates and displays a parkrunner's Wilson index on their results page.

```javascript
(async()=>{var n;function s(e,t=7){var r;let n=null;for(r of e.querySelectorAll('[id="results"]')){var a=r.querySelector("tr");if(a)if(a.querySelectorAll("th, td").length===t){n=r;break}}return n}function d(e){return Array.from(e.querySelectorAll("tbody > tr")).reverse().map(e=>{var t=e.querySelector("td:nth-child(1)").textContent.trim(),r=e.querySelector("td:nth-child(2)").textContent.trim(),e=e.querySelector("td:nth-child(3)").textContent.trim();return{eventName:t,eventDate:r,eventNumber:parseInt(e,10)}})}function i(e){let t=0;var r;for(r of e.map(e=>e.eventNumber).sort((e,t)=>e-t)){if(r>=t+2)break;r===t+1&&t++}return t}function c(t){var r=[];for(let e=0;e<t.length;e++){var n=t.slice(0,e+1),a=e+1,l=`${t[e].eventName} # ${t[e].eventNumber} on `+t[e].eventDate,n=i(n);r.push({parkruns:a,event:l,wilsonIndex:n})}return r}function u(e,a){var t=document.createElement("form");t.style.marginBottom="20px",t.style.textAlign="center";let l=document.createElement("input"),o=(l.style.width="200px",l.type="text",l.placeholder="Enter friend's athlete ID (e.g. A507)",l.style.padding="5px",l.style.marginRight="10px",l.style.borderRadius="3px",l.style.border="1px solid #ffa300",l.style.backgroundColor="#2b223d",l.style.color="#ffa300",document.createElement("button"));o.textContent="Compare",o.style.padding="5px 10px",o.style.backgroundColor="#ffa300",o.style.color="#2b223d",o.style.border="none",o.style.borderRadius="3px",o.style.cursor="pointer",t.appendChild(l),t.appendChild(o),t.addEventListener("submit",async e=>{e.preventDefault();var t,e=l.value.trim().replace(/^[aA]/,"");if(e){o.disabled=!0,o.textContent="Loading...";try{t=e,t=await(await fetch(`https://www.parkrun.com.au/parkrunner/${e}/all/`)).text();var r,n=await s((new DOMParser).parseFromString(t,"text/html"));n&&(r=c(d(n)),a(r,e))}catch(e){console.error("Failed to fetch friend's results:",e),alert("Failed to fetch friend's results. Please check the ID and try again.")}finally{o.disabled=!1,o.textContent="Compare"}}}),e.insertBefore(t,e.firstChild)}function p(e){return e.textContent.trim()}function m(e){var t=["#FFA300","#90EE90","#FF69B4","#4169E1","#FFD700","#9370DB","#20B2AA","#FF6347","#DDA0DD","#00CED1"];return t[e%t.length]}function e(){var e=s(document);if(e){var t=document.querySelector("h2");if(t){var r=p(t);if(r){var e=d(e),n=i(e),e=c(e);if(t){var a=document.createElement("div"),o=(a.style.marginTop="20px",a.style.backgroundColor="#2b223d",a.style.padding="20px",a.style.borderRadius="5px",document.createElement("div"));o.textContent="Wilson index: "+n,o.style.fontSize="1.5em",o.style.color="#ffa300",o.style.fontWeight="bold",o.style.marginBottom="20px",o.style.textAlign="center",a.appendChild(o);n=e,o=a,e=r,(r=document.createElement("canvas")).style.width="100%",r.style.height="300px",o.appendChild(r),o=r.getContext("2d");let l=new Chart(o,{type:"line",data:{labels:n.map(e=>e.parkruns),datasets:[{label:e,data:n.map(e=>({x:e.parkruns,y:e.wilsonIndex,event:e.event})),borderColor:m(0),backgroundColor:"#2b223d"}]},options:{responsive:!0,scales:{y:{beginAtZero:!0,title:{display:!0,text:"Wilson Index"},suggestedMax:Math.ceil(1.1*Math.max(...n.map(e=>e.wilsonIndex)))},x:{title:{display:!0,text:"parkruns"},min:0,suggestedMax:Math.ceil(1.1*n.length)}},plugins:{title:{display:!0,text:"Wilson Index Progress"},tooltip:{callbacks:{label:function(e){e=e.raw;return["Wilson Index: "+e.y,"Event: "+e.event]}}}}}});u(a,async(e,t)=>{var r,n,a,t=await(await fetch(window.location.origin+`/parkrunner/${t}/all/`)).text(),t=p((new DOMParser).parseFromString(t,"text/html").querySelector("h2"));r=l,e=e,n=t,a=r.data.datasets.length,n={label:t,data:e.map(e=>({x:e.parkruns,y:e.wilsonIndex,event:e.event})),borderColor:m(a),backgroundColor:"#2b223d"},r.data.datasets.push(n),r.update(),e=Math.max(...r.data.datasets.flatMap(e=>e.data.map(e=>e.x))),a=Math.max(...r.data.datasets.flatMap(e=>e.data.map(e=>e.y))),r.options.scales.x.suggestedMax=Math.ceil(1.1*e),r.options.scales.y.suggestedMax=Math.ceil(1.1*a),r.update()}),t.parentNode.insertBefore(a,t.nextSibling)}}else console.error("Could not extract athlete info")}else console.error("H2 element not found")}else console.error("Results table not found")}n="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js",await new Promise((e,t)=>{var r=document.createElement("script");r.src=n,r.onload=e,r.onerror=t,document.head.appendChild(r)}),"undefined"!=typeof module&&module.exports?module.exports={calculateWilsonIndex:i,calculateWilsonIndexOverTime:c,extractEventDetails:d,findResultsTable:s}:e()})();
```

### parkrun Volunteer Days Display

Displays the number of volunteer days for parkrun finishers on results pages

```javascript
(async()=>{!function t(){document.querySelector(".Results-table")?document.querySelectorAll("tr[data-vols] > td.Results-table-td.Results-table-td--name > div.detailed").forEach(t=>{var e,s=t.closest("tr").getAttribute("data-vols");s&&0<parseInt(s)&&((e=document.createElement("span")).textContent=s+` volunteer day${"1"===s?"":"s"} | `,e.classList.add("volunteer-days"),e.style.color="#d35226",t.insertBefore(e,t.firstChild))}):setTimeout(t,500)}()})();
```

### parkrun Charts

Displays charts on parkrun pages: finishers per minute on results pages and event history on event history pages

```javascript
(async()=>{var r;r="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js",await new Promise((e,t)=>{var o=document.createElement("script");o.src=r,o.onload=e,o.onerror=t,document.head.appendChild(o)});{let n={backgroundColor:"#2b223d",barColor:"#FFA300",lineColor:"#53BA9D",textColor:"#e0e0e0",subtleTextColor:"#cccccc",gridColor:"rgba(200, 200, 200, 0.2)"};function l(e,t,o=800){var r=document.createElement("div"),o=(r.className=`parkrun-chart-container ${t}-container`,r.style.width="100%",r.style.maxWidth=o+"px",r.style.margin="20px auto",r.style.padding="15px",r.style.backgroundColor=n.backgroundColor,r.style.borderRadius="8px",r.style.boxShadow="0 2px 4px rgba(0,0,0,0.1)",document.createElement("h3")),e=(o.textContent=e,o.style.textAlign="center",o.style.marginBottom="15px",o.style.color=n.barColor,r.appendChild(o),document.createElement("canvas"));return e.id=t,r.appendChild(e),{container:r,canvas:e}}function a(e){var t=document.querySelector(".Results-table");t&&t.parentNode?t.parentNode.insertBefore(e,t):(document.querySelector(".content")||document.body).appendChild(e)}function i(e,l,a){var t=document.createElement("div"),o=(t.style.display="flex",t.style.justifyContent="center",t.style.marginTop="10px",t.style.marginBottom="10px",document.createElement("button"));o.textContent="ðŸ’¾ Save as Image",o.style.padding="6px 12px",o.style.backgroundColor=n.barColor,o.style.color="#2b223d",o.style.border="none",o.style.borderRadius="4px",o.style.cursor="pointer",o.style.fontWeight="bold",o.style.display="inline-block",o.style.margin="0 5px",o.title="Download chart as PNG image",o.addEventListener("mouseover",function(){this.style.backgroundColor="#e59200"}),o.addEventListener("mouseout",function(){this.style.backgroundColor=n.barColor}),o.addEventListener("click",function(){var e=document.createElement("a"),t=(new Date).toISOString().split("T")[0],o=window.location.pathname.split("/"),r=o[1];let n;n="event-history"===a?r+`-event-history-${t}.png`:r+`-event-${o[3]||"latest"}-finishers-${t}.png`,e.download=n,e.href=l.toDataURL("image/png"),document.body.appendChild(e),e.click(),document.body.removeChild(e)}),t.appendChild(o),e.appendChild(t)}function e(){var e,t,o=(({timeData:t,minMinute:o,maxMinute:r})=>{var n=[],l=[];for(let e=o;e<=r;e++)n.push(e),l.push(t[e]||0);return{labels:n.map(e=>60<=e?Math.floor(e/60)+":"+(e%60).toString().padStart(2,"0"):e+"'"),data:l}})((()=>{let n={};var e=document.querySelectorAll("tr.Results-table-row");let l=1/0,a=0;e.forEach(t=>{t=t.querySelector("td.Results-table-td--time");if(t){t=t.textContent.trim();let e;var o=t.match(/(\d+):(\d+):(\d+)/);if(o){var r=parseInt(o[1]),o=parseInt(o[2]);e=60*r+o}else{r=t.match(/(\d+):(\d+)/);if(!r)return;e=parseInt(r[1])}l=Math.min(l,e),a=Math.max(a,e),n[e]?n[e]++:n[e]=1}});for(let e=l;e<=a;e++)n[e]||(n[e]=0);return{timeData:n,minMinute:l,maxMinute:a}})());0===o.labels.length?console.log("No finish time data found"):document.getElementById("finishersChart")?console.log("Finishers chart already exists, skipping render"):({container:t,canvas:e}=l("Finishers per Minute","finishersChart"),a(t),i(t,e,"finishers"),t=e.getContext("2d"),new Chart(t,{type:"bar",data:{labels:o.labels,datasets:[{label:"Number of Finishers",data:o.data,backgroundColor:n.barColor,borderColor:n.barColor,borderWidth:1}]},options:{animation:!1,responsive:!0,plugins:{legend:{labels:{color:n.textColor}},title:{display:!1,color:n.textColor},tooltip:{callbacks:{title:e=>{var t,o,e=e[0].label;return e.includes(":")?([o,t]=e.split(":"),o+` hour${"1"===o?"":"s"} ${t} minute`+("01"===t?"":"s")):(o=e.replace("'",""))+" minute"+("1"===o?"":"s")},label:e=>e.raw+" finisher"+(1===e.raw?"":"s")}}},scales:{x:{title:{display:!0,text:"Finish Time",color:n.textColor},ticks:{color:n.subtleTextColor},grid:{color:n.gridColor}},y:{beginAtZero:!0,title:{display:!0,text:"Number of Finishers",color:n.textColor},ticks:{precision:0,color:n.subtleTextColor},grid:{color:n.gridColor}}}}}))}function t(){if(document.getElementById("eventHistoryChart"))console.log("Event history chart already exists, skipping render");else{let t=(()=>{let o=[],r=[],n=[],l=[];var e=document.querySelectorAll("tr.Results-table-row");return Array.from(e).reverse().forEach(e=>{var t=e.getAttribute("data-parkrun"),t=(t&&o.push(t),e.getAttribute("data-date")),t=(t&&(t=new Date(t).toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"}),r.push(t)),e.getAttribute("data-finishers")),t=(t&&n.push(parseInt(t,10)),e.getAttribute("data-volunteers"));t&&l.push(parseInt(t,10))}),{eventNumbers:o,dates:r,finishers:n,volunteers:l}})();var e,o;0===t.eventNumbers.length?console.log("No event history data found"):({container:o,canvas:e}=l("Event History: Finishers & Volunteers","eventHistoryChart",1e3),e.height=400,e.style.height="400px",e.style.maxHeight="400px",a(o),i(o,e,"event-history"),o=e.getContext("2d"),new Chart(o,{type:"bar",data:{labels:t.eventNumbers,datasets:[{label:"Finishers",data:t.finishers,backgroundColor:n.barColor,borderColor:n.barColor,borderWidth:1,yAxisID:"y-finishers",order:1},{label:"Volunteers",data:t.volunteers,type:"line",borderColor:n.lineColor,backgroundColor:"rgba(83, 186, 157, 0.2)",borderWidth:1,pointBackgroundColor:n.lineColor,pointRadius:2,fill:!1,tension:.2,yAxisID:"y-volunteers",order:0}]},options:{animation:!1,responsive:!0,maintainAspectRatio:!0,aspectRatio:2.5,onResize:null,plugins:{legend:{labels:{color:n.textColor,usePointStyle:!0}},tooltip:{mode:"index",callbacks:{title:function(e){e=e[0].dataIndex;return`Event #${t.eventNumbers[e]} (${t.dates[e]})`},label:function(e){var t=e.dataset.label||"";return"Finishers"===t?"Finishers: "+e.raw:"Volunteers"===t?"Volunteers: "+e.raw:e.formattedValue}}}},scales:{x:{title:{display:!0,text:"Event Number",color:n.textColor},ticks:{color:n.subtleTextColor},grid:{color:n.gridColor}},"y-finishers":{type:"linear",position:"left",beginAtZero:!0,title:{display:!0,text:"Number of Finishers",color:n.textColor},ticks:{precision:0,color:n.subtleTextColor},grid:{color:n.gridColor}},"y-volunteers":{type:"linear",position:"right",beginAtZero:!0,title:{display:!0,text:"Number of Volunteers",color:n.lineColor},ticks:{precision:0,color:n.lineColor},grid:{display:!1}}}}}))}}"undefined"==typeof Chart?console.error("Chart.js not loaded"):document.querySelector(".Results-table")?(window.location.href.includes("/eventhistory/")?t:e)():console.log("Results table not found")}})();
```

### parkrun p-index display

The parkrun p-index is an unofficial statistic that measures the number of different parkrun events a person has completed a specific number of times. To achieve a p-index of 10, you must have completed at least 10 different parkrun events 10 times each. This script calculate the p-index for a parkrunner and displays it on their results page.

```javascript
(async()=>{if("undefined"!=typeof module&&module.exports)module.exports={calculatePIndex:o,extractEventDetails:t,findResultsTable:n};else{var e=n();if(e){({pIndex:e,contributingEvents:r}=o(t(e)));var r,l=document.querySelector("h2");if(l){let t=document.createElement("div"),n=(t.textContent="p-index: "+e,t.style.fontSize="1.5em",t.style.fontWeight="bold",t.style.marginTop="10px",t.style.backgroundColor="#2b223d",t.style.color="#ffa300",t.style.padding="10px",t.style.borderRadius="5px",t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="center",t.style.justifyContent="center",t.setAttribute("id","p-index-display"),document.createElement("ul"));n.style.listStyleType="none",n.style.padding="0",r.forEach(e=>{var t=document.createElement("li");t.textContent=e,t.style.fontWeight="normal",t.style.fontSize="1em",n.appendChild(t)}),t.appendChild(n),l.parentNode.insertBefore(t,l.nextSibling),setTimeout(()=>{var e=t.getBoundingClientRect(),e=Math.max(e.width,e.height);t.style.width=e+"px",t.style.height=e+"px"},0)}}else console.error("Results table not found")}function t(e){let r=[];e.querySelectorAll("tbody > tr").forEach(e=>{var t=e.querySelector("td:nth-child(1) > a").textContent.trim(),n=e.querySelector("td:nth-child(2)").textContent.trim(),e=e.querySelector("td:nth-child(3)").textContent.trim();r.unshift({eventName:t,date:n,eventNumber:e})});e=r.reduce((e,{eventName:t,date:n,eventNumber:r})=>(e[t]||(e[t]=[]),e[t].push({date:n,eventNumber:r}),e),{});return Object.entries(e).sort((e,t)=>t[1].length-e[1].length)}function n(){var e=document.querySelectorAll("#results");return e[e.length-1]}function o(e){e=e.filter(([,e],t)=>e.length>t);let l=e.length;function o(e){return new Date(e.split("/").reverse().join("-"))}e=e.map(([e,t])=>{var n=t[0],r=t[l-1];return{eventName:e,eventCount:t.length,firstDate:n.date,firstEventNumber:n.eventNumber,pIndexDate:r.date,pIndexEventNumber:r.eventNumber,firstDateForSorting:o(n.date),pIndexDateForSorting:o(r.date)}}).sort((e,t)=>e.pIndexDateForSorting-t.pIndexDateForSorting).slice(0,l).map(e=>e.eventName+` (${e.eventCount}): ${e.firstDate} (#${e.firstEventNumber}) - ${e.pIndexDate} (#${e.pIndexEventNumber})`);return{pIndex:l,contributingEvents:e}}})();
```
<!-- END BOOKMARKLETS SECTION -->





