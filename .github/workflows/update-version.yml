---
name: Update Userscript Version

on:
    push:
        branches:
            - main
        paths:
            - '*.user.js'

jobs:
    update-version:
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - uses: actions/checkout@v4

            - name: Update version string
              run: |
                  date_today=$(date +%Y-%m-%d)

                  update_version() {
                    local file=$1
                    local current_version=$(grep -oP '(?<=@version\s{2,}).*' "$file")
                    local date_prefix=$(echo "$current_version" | cut -d'-' -f1-3)
                    
                    # If version already has today's date
                    if [[ "$date_prefix" == "$date_today" ]]; then
                      # Check if there's already a time component
                      if [[ "$current_version" =~ $date_today\ ([0-9]{2}:[0-9]{2}(:[0-9]{2})?) ]]; then
                        # Update seconds
                        local time=$(echo "$current_version" | grep -oP "$date_today \K.*")
                        if [[ "$time" =~ ([0-9]{2}:[0-9]{2})$ ]]; then
                          # Add seconds
                          new_version="$date_today ${BASH_REMATCH[1]}:$(date +%S)"
                        else
                          # Update seconds
                          new_version="$date_today $(date +%H:%M:%S)"
                        fi
                      else
                        # Add time (hours and minutes)
                        new_version="$date_today $(date +%H:%M)"
                      fi
                    else
                      # Simply use today's date
                      new_version="$date_today"
                    fi
                    
                    echo "Updating $file from $current_version to $new_version"
                    sed -i -e "s/@version\s\+$current_version/@version      $new_version/" "$file"
                  }

                  # Update all userscripts
                  for file in *.user.js; do
                    [ -f "$file" ] && update_version "$file"
                  done

            - name: Commit changes
              uses: stefanzweifel/git-auto-commit-action@v5
              with:
                  commit_message: 'chore: update userscript versions [skip ci]'
                  file_pattern: '*.user.js'
                  branch: main
