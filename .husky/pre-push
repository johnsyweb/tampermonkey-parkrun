#!/bin/bash

# Pre-push: run full CI (build, check, test, lint, docs:build) then screenshot logic

set -e

# Ensure pnpm from mise is on PATH (hooks run with minimal env)
export PATH="${MISE_DATA_DIR:-$HOME/.local/share/mise}/shims:$PATH"

# Skip in CI (GitHub Actions runs its own pipeline)
if [ "$CI" = "true" ] || [ "$GITHUB_ACTIONS" = "true" ]; then
  echo "‚è≠Ô∏è  Skipping pre-push hooks in CI environment"
  exit 0
fi

echo "üîç Running full CI (build, check, test, lint, docs:build)..."
if ! pnpm run ci; then
  echo ""
  echo "‚ùå CI failed. Fix the issues above before pushing."
  exit 1
fi
echo "‚úÖ CI passed."
echo ""

# Generate screenshots if userscripts have been modified

# Get the list of files being pushed
while read local_ref local_sha remote_ref remote_sha; do
  if [ "$local_sha" != "0000000000000000000000000000000000000000" ]; then
    # Check if this is a new branch or if we're pushing updates
    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
      # New branch - check all commits
      range="$local_sha"
    else
      # Existing branch - check commits between remote and local
      range="$remote_sha..$local_sha"
    fi

    # Check if any .user.js files have been modified
    modified_files=$(git diff --name-only --diff-filter=ACMR "$range" | grep -E '\.user\.js$' || true)

    if [ -n "$modified_files" ]; then
      echo "üì∏ Detected modified userscript files:"
      echo "$modified_files" | sed 's/^/  - /'
      echo ""
      echo "üîÑ Generating screenshots locally..."
      
      if ! pnpm screenshots; then
        echo ""
        echo "‚ùå Screenshot generation failed!"
        echo "Please fix any issues and try again."
        exit 1
      fi
      
      echo ""
      echo "‚úÖ Screenshots generated successfully!"
      echo "üí° Remember to commit the updated screenshots before pushing."
    fi
  fi
done

exit 0

